/*
 * SettingsDialog.java Created on 31 Октябрь 2008 г., 22:43
 */
package org.jbookshelf.gui;

import java.awt.Component;
import java.io.File;
import java.util.ArrayList;
import java.util.HashMap;
import java.util.List;
import java.util.Locale;
import java.util.Map;
import java.util.ResourceBundle;

import javax.swing.JButton;
import javax.swing.JLabel;
import javax.swing.LookAndFeel;
import javax.swing.SwingUtilities;
import javax.swing.UIManager;
import javax.swing.UIManager.LookAndFeelInfo;

import org.util.settings.JBookShelfSettings;
import org.util.settings.Settings;

/**
 * @author eav
 */
public class SettingsDialog
    extends javax.swing.JDialog
{
    private Settings settings = Settings.getInstance();

    /** Creates new form SettingsDialog */
    public SettingsDialog(
        java.awt.Frame parent,
        boolean modal )
    {
        super( parent, modal );
        initComponents();
        registerComponents();

        prepareSettings();
        arrangeSettingValues();
    }

    private void arrangeSettingValues()
    {
        langComboBox.setSelectedItem( settings.getProperty( JBookShelfSettings.LANGUAGE ) );
        langComboBoxActionPerformed( null );
        lafComboBox.setSelectedItem( settings.getProperty( JBookShelfSettings.LAF ) );
        lafComboBoxActionPerformed( null );
        tmpTextField.setText( settings.getProperty( JBookShelfSettings.TEMP_FOLDER ) );
        jbsTextField.setText( settings.getProperty( JBookShelfSettings.JBS_FOLDER ) );
        importTextField.setText( settings.getProperty( JBookShelfSettings.IMPORT_MASK ) );
    }

    private void prepareSettings()
    {
        settings.loadDefaults();
        String folderName = settings.getProperty( JBookShelfSettings.JBS_FOLDER );
        File folder = new File( folderName );
        String fileName = getSettingsFileName();
        File file = new File( fileName );
        if ( file.exists() )
        {
            settings.load( fileName );
        }
        else
        {
            if ( !folder.exists() )
            {
                folder.mkdir();
            }
            settings.save( fileName, true );
        }
    }

    private String getSettingsFileName()
    {
        return settings.getProperty( JBookShelfSettings.JBS_FOLDER ) + File.separator + "settings.properties";
    }

    /**
     * This method is called from within the constructor to initialize the form. WARNING: Do NOT modify this code. The
     * content of this method is always regenerated by the Form Editor.
     */
    @SuppressWarnings( "unchecked" )
    // <editor-fold defaultstate="collapsed" desc="Generated Code">//GEN-BEGIN:initComponents
    private void initComponents()
    {

        restoreButton = new javax.swing.JButton();
        cancelButton = new javax.swing.JButton();
        okButton = new javax.swing.JButton();
        saveButton = new javax.swing.JButton();
        jLabel1 = new javax.swing.JLabel();
        jSeparator1 = new javax.swing.JSeparator();
        jLabel2 = new javax.swing.JLabel();
        jLabel3 = new javax.swing.JLabel();
        jLabel4 = new javax.swing.JLabel();
        jLabel5 = new javax.swing.JLabel();
        jLabel6 = new javax.swing.JLabel();
        importTextField = new javax.swing.JTextField();
        jbsTextField = new javax.swing.JTextField();
        jButton2 = new javax.swing.JButton();
        tmpTextField = new javax.swing.JTextField();
        jButton6 = new javax.swing.JButton();
        lafComboBox = new javax.swing.JComboBox();
        langComboBox = new javax.swing.JComboBox();

        setDefaultCloseOperation( javax.swing.WindowConstants.DISPOSE_ON_CLOSE );
        setName( "Form" ); // NOI18N

        java.util.ResourceBundle bundle = java.util.ResourceBundle.getBundle( "org/jbookshelf/gui/Bundle" ); // NOI18N
        restoreButton.setText( bundle.getString( "SettingsDialog.restoreButton.text" ) ); // NOI18N
        restoreButton.setName( "restoreButton" ); // NOI18N
        restoreButton.addActionListener( new java.awt.event.ActionListener()
        {
            public void actionPerformed(
                java.awt.event.ActionEvent evt )
            {
                restoreButtonActionPerformed( evt );
            }
        } );

        cancelButton.setText( bundle.getString( "SettingsDialog.cancelButton.text" ) ); // NOI18N
        cancelButton.setName( "cancelButton" ); // NOI18N
        cancelButton.addActionListener( new java.awt.event.ActionListener()
        {
            public void actionPerformed(
                java.awt.event.ActionEvent evt )
            {
                cancelButtonActionPerformed( evt );
            }
        } );

        okButton.setText( bundle.getString( "SettingsDialog.okButton.text" ) ); // NOI18N
        okButton.setName( "okButton" ); // NOI18N
        okButton.addActionListener( new java.awt.event.ActionListener()
        {
            public void actionPerformed(
                java.awt.event.ActionEvent evt )
            {
                okButtonActionPerformed( evt );
            }
        } );

        saveButton.setText( bundle.getString( "SettingsDialog.saveButton.text" ) ); // NOI18N
        saveButton.setName( "saveButton" ); // NOI18N
        saveButton.addActionListener( new java.awt.event.ActionListener()
        {
            public void actionPerformed(
                java.awt.event.ActionEvent evt )
            {
                saveButtonActionPerformed( evt );
            }
        } );

        jLabel1.setFont( new java.awt.Font( "Dialog", 1, 18 ) );
        jLabel1.setText( bundle.getString( "SettingsDialog.jLabel1.text" ) ); // NOI18N
        jLabel1.setName( "jLabel1" ); // NOI18N

        jSeparator1.setName( "jSeparator1" ); // NOI18N

        jLabel2.setText( bundle.getString( "SettingsDialog.jLabel2.text" ) ); // NOI18N
        jLabel2.setName( "jLabel2" ); // NOI18N

        jLabel3.setText( bundle.getString( "SettingsDialog.jLabel3.text" ) ); // NOI18N
        jLabel3.setName( "jLabel3" ); // NOI18N

        jLabel4.setText( bundle.getString( "SettingsDialog.jLabel4.text" ) ); // NOI18N
        jLabel4.setName( "jLabel4" ); // NOI18N

        jLabel5.setText( bundle.getString( "SettingsDialog.jLabel5.text" ) ); // NOI18N
        jLabel5.setName( "jLabel5" ); // NOI18N

        jLabel6.setText( bundle.getString( "SettingsDialog.jLabel6.text" ) ); // NOI18N
        jLabel6.setName( "jLabel6" ); // NOI18N

        importTextField.setText( bundle.getString( "SettingsDialog.importTextField.text" ) ); // NOI18N
        importTextField.setName( "importTextField" ); // NOI18N

        jbsTextField.setText( bundle.getString( "SettingsDialog.jbsTextField.text" ) ); // NOI18N
        jbsTextField.setName( "jbsTextField" ); // NOI18N

        jButton2.setText( bundle.getString( "SettingsDialog.jButton2.text" ) ); // NOI18N
        jButton2.setName( "jButton2" ); // NOI18N

        tmpTextField.setText( bundle.getString( "SettingsDialog.tmpTextField.text" ) ); // NOI18N
        tmpTextField.setName( "tmpTextField" ); // NOI18N

        jButton6.setText( bundle.getString( "SettingsDialog.jButton6.text" ) ); // NOI18N
        jButton6.setName( "jButton6" ); // NOI18N

        lafComboBox.setModel( new javax.swing.DefaultComboBoxModel( getLAFs() ) );
        lafComboBox.setName( "lafComboBox" ); // NOI18N
        lafComboBox.addActionListener( new java.awt.event.ActionListener()
        {
            public void actionPerformed(
                java.awt.event.ActionEvent evt )
            {
                lafComboBoxActionPerformed( evt );
            }
        } );

        langComboBox.setModel( new javax.swing.DefaultComboBoxModel( new String[] { "Russian", "English" } ) );
        langComboBox.setName( "langComboBox" ); // NOI18N
        langComboBox.addActionListener( new java.awt.event.ActionListener()
        {
            public void actionPerformed(
                java.awt.event.ActionEvent evt )
            {
                langComboBoxActionPerformed( evt );
            }
        } );

        javax.swing.GroupLayout layout = new javax.swing.GroupLayout( getContentPane() );
        getContentPane().setLayout( layout );
        layout.setHorizontalGroup( layout.createParallelGroup( javax.swing.GroupLayout.Alignment.LEADING ).addGroup(
            layout.createSequentialGroup().addComponent( jLabel1 ).addContainerGap() ).addComponent( jSeparator1,
            javax.swing.GroupLayout.DEFAULT_SIZE, 640, Short.MAX_VALUE ).addGroup(
            layout.createSequentialGroup().addContainerGap().addComponent( saveButton ).addPreferredGap(
                javax.swing.LayoutStyle.ComponentPlacement.RELATED ).addComponent( restoreButton ).addPreferredGap(
                javax.swing.LayoutStyle.ComponentPlacement.RELATED, 270, Short.MAX_VALUE ).addComponent( okButton )
                .addPreferredGap( javax.swing.LayoutStyle.ComponentPlacement.RELATED ).addComponent( cancelButton )
                .addContainerGap() ).addGroup(
            layout.createSequentialGroup().addContainerGap().addGroup(
                layout.createParallelGroup( javax.swing.GroupLayout.Alignment.LEADING ).addComponent( jLabel6 )
                    .addComponent( jLabel5 ).addComponent( jLabel4 ).addComponent( jLabel3 ).addComponent( jLabel2 ) )
                .addPreferredGap( javax.swing.LayoutStyle.ComponentPlacement.RELATED ).addGroup(
                    layout.createParallelGroup( javax.swing.GroupLayout.Alignment.LEADING ).addComponent(
                        importTextField, javax.swing.GroupLayout.DEFAULT_SIZE, 519, Short.MAX_VALUE ).addGroup(
                        javax.swing.GroupLayout.Alignment.TRAILING,
                        layout.createSequentialGroup().addGroup(
                            layout.createParallelGroup( javax.swing.GroupLayout.Alignment.TRAILING ).addComponent(
                                langComboBox, javax.swing.GroupLayout.Alignment.LEADING, 0, 430, Short.MAX_VALUE )
                                .addComponent( lafComboBox, javax.swing.GroupLayout.Alignment.LEADING, 0, 430,
                                    Short.MAX_VALUE ).addComponent( tmpTextField,
                                    javax.swing.GroupLayout.Alignment.LEADING, javax.swing.GroupLayout.DEFAULT_SIZE,
                                    430, Short.MAX_VALUE ).addComponent( jbsTextField,
                                    javax.swing.GroupLayout.DEFAULT_SIZE, 430, Short.MAX_VALUE ) ).addPreferredGap(
                            javax.swing.LayoutStyle.ComponentPlacement.RELATED ).addGroup(
                            layout.createParallelGroup( javax.swing.GroupLayout.Alignment.LEADING ).addComponent(
                                jButton6 ).addComponent( jButton2 ) ) ) ).addContainerGap() ) );
        layout.setVerticalGroup( layout.createParallelGroup( javax.swing.GroupLayout.Alignment.LEADING ).addGroup(
            javax.swing.GroupLayout.Alignment.TRAILING,
            layout.createSequentialGroup().addComponent( jLabel1 ).addPreferredGap(
                javax.swing.LayoutStyle.ComponentPlacement.RELATED ).addComponent( jSeparator1,
                javax.swing.GroupLayout.PREFERRED_SIZE, 10, javax.swing.GroupLayout.PREFERRED_SIZE ).addPreferredGap(
                javax.swing.LayoutStyle.ComponentPlacement.RELATED ).addGroup(
                layout.createParallelGroup( javax.swing.GroupLayout.Alignment.BASELINE ).addComponent( jLabel2 )
                    .addComponent( langComboBox, javax.swing.GroupLayout.PREFERRED_SIZE,
                        javax.swing.GroupLayout.DEFAULT_SIZE, javax.swing.GroupLayout.PREFERRED_SIZE ) ).addGap( 18,
                18, 18 ).addGroup(
                layout.createParallelGroup( javax.swing.GroupLayout.Alignment.BASELINE ).addComponent( jLabel3 )
                    .addComponent( lafComboBox, javax.swing.GroupLayout.PREFERRED_SIZE,
                        javax.swing.GroupLayout.DEFAULT_SIZE, javax.swing.GroupLayout.PREFERRED_SIZE ) ).addGap( 18,
                18, 18 ).addGroup(
                layout.createParallelGroup( javax.swing.GroupLayout.Alignment.BASELINE ).addComponent( jLabel4 )
                    .addComponent( tmpTextField, javax.swing.GroupLayout.PREFERRED_SIZE,
                        javax.swing.GroupLayout.DEFAULT_SIZE, javax.swing.GroupLayout.PREFERRED_SIZE ).addComponent(
                        jButton6 ) ).addGap( 18, 18, 18 ).addGroup(
                layout.createParallelGroup( javax.swing.GroupLayout.Alignment.BASELINE ).addComponent( jLabel5 )
                    .addComponent( jButton2 ).addComponent( jbsTextField, javax.swing.GroupLayout.PREFERRED_SIZE,
                        javax.swing.GroupLayout.DEFAULT_SIZE, javax.swing.GroupLayout.PREFERRED_SIZE ) ).addGap( 18,
                18, 18 ).addGroup(
                layout.createParallelGroup( javax.swing.GroupLayout.Alignment.BASELINE ).addComponent( jLabel6 )
                    .addComponent( importTextField, javax.swing.GroupLayout.PREFERRED_SIZE,
                        javax.swing.GroupLayout.DEFAULT_SIZE, javax.swing.GroupLayout.PREFERRED_SIZE ) ).addGap( 18,
                18, 18 ).addGroup(
                layout.createParallelGroup( javax.swing.GroupLayout.Alignment.BASELINE ).addComponent( saveButton )
                    .addComponent( restoreButton ).addComponent( cancelButton ).addComponent( okButton ) )
                .addContainerGap() ) );

        pack();
    }// </editor-fold>//GEN-END:initComponents

    private void okButtonActionPerformed(
        java.awt.event.ActionEvent evt )
    {// GEN-FIRST:event_okButtonActionPerformed
        settings.save( getSettingsFileName(), true );
        setVisible( false );
    }// GEN-LAST:event_okButtonActionPerformed

    private void cancelButtonActionPerformed(
        java.awt.event.ActionEvent evt )
    {// GEN-FIRST:event_cancelButtonActionPerformed
        setVisible( false );
    }// GEN-LAST:event_cancelButtonActionPerformed

    private void restoreButtonActionPerformed(
        java.awt.event.ActionEvent evt )
    {// GEN-FIRST:event_restoreButtonActionPerformed
        settings.loadDefaults();
        arrangeSettingValues();
    }// GEN-LAST:event_restoreButtonActionPerformed

    private void saveButtonActionPerformed(
        java.awt.event.ActionEvent evt )
    {// GEN-FIRST:event_saveButtonActionPerformed
        settings.saveAsDefaults();
    }// GEN-LAST:event_saveButtonActionPerformed

    private void lafComboBoxActionPerformed(
        java.awt.event.ActionEvent evt )
    {// GEN-FIRST:event_lafComboBoxActionPerformed
        try
        {
            String lafName = lafComboBox.getSelectedItem().toString();
            settings.setProperty( JBookShelfSettings.LAF, lafName );
            UIManager.setLookAndFeel( lafClassNames.get( lafName ) );
            SwingUtilities.updateComponentTreeUI( this );
            pack();
        }
        catch ( Exception ex )
        {
            throw new Error( ex );
        }
    }// GEN-LAST:event_lafComboBoxActionPerformed

    private void langComboBoxActionPerformed(
        java.awt.event.ActionEvent evt )
    {// GEN-FIRST:event_langComboBoxActionPerformed
        String language = langComboBox.getSelectedItem().toString();
        settings.setProperty( JBookShelfSettings.LANGUAGE, language );
        ResourceBundle bundle;
        if ( language.equals( "Russian" ) )
        {
            bundle = ResourceBundle.getBundle( "org/jbookshelf/gui/Bundle", new Locale( "ru", "RU" ) );
        }
        else
        {
            bundle = ResourceBundle.getBundle( "org/jbookshelf/gui/Bundle", new Locale( "en", "US" ) );
        }

        for ( Component component : components )
        {
            String text = bundle.getString( "SettingsDialog." + component.getName() + ".text" );
            if ( component instanceof JButton )
            {
                ((JButton) component).setText( text );
            }
            else if ( component instanceof JLabel )
            {
                ((JLabel) component).setText( text );
            }
        }
    }// GEN-LAST:event_langComboBoxActionPerformed

    /**
     * @param args the command line arguments
     */
    public static void main(
        String args[] )
    {
        java.awt.EventQueue.invokeLater( new Runnable()
        {
            @Override
            public void run()
            {
                SettingsDialog dialog = new SettingsDialog( new javax.swing.JFrame(), true );
                dialog.addWindowListener( new java.awt.event.WindowAdapter()
                {
                    @Override
                    public void windowClosing(
                        java.awt.event.WindowEvent e )
                    {
                        System.exit( 0 );
                    }
                } );
                dialog.setVisible( true );
            }
        } );
    }

    /**
     * stores {@link LookAndFeel} classNames
     */
    private static Map<String, String> lafClassNames = new HashMap<String, String>();

    /**
     * @return {@link LookAndFeel} names for combobox
     */
    private static String[] getLAFs()
    {
        LookAndFeelInfo[] installed = UIManager.getInstalledLookAndFeels();
        String[] lafs = new String[installed.length];
        for ( int i = 0; i < installed.length; i++ )
        {
            LookAndFeelInfo lookAndFeelInfo = installed[i];
            lafs[i] = lookAndFeelInfo.getName();
            lafClassNames.put( lafs[i], lookAndFeelInfo.getClassName() );
        }
        return lafs;
    }

    /**
     * stores component names to iterate while changing locale
     */
    private List<Component> components = new ArrayList<Component>();

    /**
     * register components to be localized
     */
    private void registerComponents()
    {
        components.add( restoreButton );
        components.add( jButton2 );
        components.add( cancelButton );
        components.add( okButton );
        components.add( saveButton );
        components.add( jButton6 );

        components.add( jLabel1 );
        components.add( jLabel2 );
        components.add( jLabel3 );
        components.add( jLabel4 );
        components.add( jLabel5 );
        components.add( jLabel6 );
    }

    // Variables declaration - do not modify//GEN-BEGIN:variables
    private javax.swing.JButton    cancelButton;
    private javax.swing.JTextField importTextField;
    private javax.swing.JButton    jButton2;
    private javax.swing.JButton    jButton6;
    private javax.swing.JLabel     jLabel1;
    private javax.swing.JLabel     jLabel2;
    private javax.swing.JLabel     jLabel3;
    private javax.swing.JLabel     jLabel4;
    private javax.swing.JLabel     jLabel5;
    private javax.swing.JLabel     jLabel6;
    private javax.swing.JSeparator jSeparator1;
    private javax.swing.JTextField jbsTextField;
    private javax.swing.JComboBox  lafComboBox;
    private javax.swing.JComboBox  langComboBox;
    private javax.swing.JButton    okButton;
    private javax.swing.JButton    restoreButton;
    private javax.swing.JButton    saveButton;
    private javax.swing.JTextField tmpTextField;
    // End of variables declaration//GEN-END:variables
}
